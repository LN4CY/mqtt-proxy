# MQTT Proxy Debugging Walkthrough

## Issues Resolved
### 1. Library Crash (`logging` error)
**Root Cause:** The `meshtastic` library (v2.7.5) crashed when receiving an integer port number instead of a stream for `debugOut`.
**Fix:** Explicitly passed `portNumber=4404` as a keyword argument in [tcp-mqtt-proxy.py](file:///C:/Users/dremb/.gemini/antigravity/brain/cd00e979-2d9a-4abd-80d8-38d6d36e6d90/tcp-mqtt-proxy.py).

### 2. Message Loss / Instability (Protobuf Mismatch)
**Root Cause:** Incompatibility between the library and Node Firmware caused `DecodeError` exceptions. This prevented the proxy from learning channel names from the node, causing it to drop or mislabel messages.

**Fix:**
- **Crash Protection:** Updated proxy to catch and suppress `DecodeError` instead of crashing.
- **Resilience:** Implemented a fallback to use `Chan_<Index>` for topic names if name lookup fails.
- **Manual Mapping:** Added `CHANNEL_MAP` environment variable to [docker-compose.yml](file:///C:/Users/dremb/.gemini/antigravity/brain/cd00e979-2d9a-4abd-80d8-38d6d36e6d90/docker-compose.yml) and fixed a logic bug where the proxy ignored it.

## Final Configuration
We successfully retrieved the channel list from your node and updated your [docker-compose.yml](file:///C:/Users/dremb/.gemini/antigravity/brain/cd00e979-2d9a-4abd-80d8-38d6d36e6d90/docker-compose.yml) with the correct map:

```yaml
    environment:
      # Found on Node via investigation
      - CHANNEL_MAP=0:LongFast,1:NCMesh,2:NCBotmesh,3:LN4CY_01,37:MCRG256
```

## Verification Results
- **Incoming Messages:** Packets from channels like `NCMesh` and `NCBotmesh` are now correctly named in MQTT topics (e.g. `msh/US/2/e/NCBotmesh/...`).
- **Stability:** The proxy handles protocol errors gracefully without restarting.
- **Contention Warning:** While the proxy *can* run alongside the iOS app, both are competing for the same single TCP connection on the Node. This effectively "splits" the traffic or causes one to disconnect. 
    - **Confirmed:** When running solo, the Docker proxy receives 100% of messages.
    - **Observation:** When running parallel, you may see gaps in messages on one or both proxies. This is a hardware limitation, not a software bug.
