# Proxy Verification Plan

## Goal
Verify that the `tcp-mqtt-proxy.py` correctly handles bidirectional traffic between the Meshtastic TCP node and the MQTT broker.

## Issues Identified
> [!WARNING]
> Meshtastic library v2.7.5 (required by user) contains a bug where `StreamInterface` interacts incorrectly with `TCPInterface` sockets, causing an `'int' object has no attribute 'write'` crash during connection.

## Resolution Strategy
We will apply a runtime monkey-patch in `tcp-mqtt-proxy.py` to fix the library bug, allowing it to work with the required version.

### 1. Patch Logic
- Intercept `meshtastic.stream_interface.StreamInterface._writeBytes`.
- Check if `self.stream` is an integer (file descriptor).
- If integer: Use `os.write(self.stream, b)`.
- If object: Use original method.

### 2. Live Execution & Monitoring
- Deploy patched `tcp-mqtt-proxy.py`.
- Run with `docker compose up --build`.

### 3. Verification Scenarios
#### A. Connection
- Ensure proxy connects without crashing (Node config loaded).

#### B. Map/NodeInfo Update
- Wait for node updates (logs `Publishing to MQTT`).

#### C. RX Packet
- Send message to node and verify MQTT publication.

## Proposed Changes
### [Gateway]
#### [MODIFY] [tcp-mqtt-proxy.py](file:///mqttgateway/home/pi/MeshMonitor/mqttgateway/tcp-mqtt-proxy.py)
   - Add monkey-patch code block before main execution.
