# Proxy Verification Plan

## Goal
Verify that the [tcp-mqtt-proxy.py](file:///C:/Users/dremb/.gemini/antigravity/brain/cd00e979-2d9a-4abd-80d8-38d6d36e6d90/tcp-mqtt-proxy.py) correctly handles bidirectional traffic between the Meshtastic TCP node and the MQTT broker.

## Issues Identified
> [!WARNING]
> Crash `AttributeError: 'int' object has no attribute 'write'` is caused by incorrect positional arguments. The [TCPInterface](file:///C:/Users/dremb/.gemini/antigravity/brain/cd00e979-2d9a-4abd-80d8-38d6d36e6d90/tcp-mqtt-proxy.py#381-407) constructor expects `debugOut` as the 2nd argument, but the code passes the port number (`4404`).

> [!CRITICAL]
> **Protobuf Mismatch Detected**: The `meshtastic` library (v2.7.5) is failing to parse packets from the node, throwing `DecodeError: Wrong wire type` and `Truncated message`. This prevents specific channel mapping (causing "Channel NOT FOUND" warnings) and affects stability.

## Resolution Strategy
1.  **Immediate Fix:** Patched [tcp-mqtt-proxy.py](file:///C:/Users/dremb/.gemini/antigravity/brain/cd00e979-2d9a-4abd-80d8-38d6d36e6d90/tcp-mqtt-proxy.py) to fix the `AttributeError`. (Done)
2.  **Next Steps:** Investigate Firmware vs Library compatibility. The user must verify the FW version matches the v2.7.x family.

### 1. Code Fix
- Change [RawTCPInterface(Host, Port, ...)](file:///C:/Users/dremb/.gemini/antigravity/brain/cd00e979-2d9a-4abd-80d8-38d6d36e6d90/tcp-mqtt-proxy.py#381-407) to [RawTCPInterface(Host, portNumber=Port, ...)](file:///C:/Users/dremb/.gemini/antigravity/brain/cd00e979-2d9a-4abd-80d8-38d6d36e6d90/tcp-mqtt-proxy.py#381-407) in [main()](file:///C:/Users/dremb/.gemini/antigravity/brain/cd00e979-2d9a-4abd-80d8-38d6d36e6d90/tcp-mqtt-proxy.py#408-463).

### 2. Live Execution & Monitoring
- Deploy patched [tcp-mqtt-proxy.py](file:///C:/Users/dremb/.gemini/antigravity/brain/cd00e979-2d9a-4abd-80d8-38d6d36e6d90/tcp-mqtt-proxy.py).
- Run with `docker compose up --build`.

### 3. Verification Scenarios
#### A. Connection
- Ensure proxy connects without crashing (Node config loaded).

#### B. Map/NodeInfo Update
- Wait for node updates (logs `Publishing to MQTT`).

## Proposed Changes
### [Gateway]
#### [MODIFY] [tcp-mqtt-proxy.py](file:///mqttgateway/home/pi/MeshMonitor/mqttgateway/tcp-mqtt-proxy.py)
   - Update [RawTCPInterface](file:///C:/Users/dremb/.gemini/antigravity/brain/cd00e979-2d9a-4abd-80d8-38d6d36e6d90/tcp-mqtt-proxy.py#381-407) instantiation arguments.
