services:
  mqtt-proxy:
    build: .
    image: mqtt-proxy
    container_name: mqtt-proxy
    restart: unless-stopped
    environment:
      # Interface selection
      - INTERFACE_TYPE=${INTERFACE_TYPE:-tcp}  # tcp, serial, or ble
      
      # Node connection settings
      - TCP_NODE_HOST=${TCP_NODE_HOST:-localhost}
      - TCP_NODE_PORT=${TCP_NODE_PORT:-4403}
      - SERIAL_PORT=${SERIAL_PORT:-/dev/ttyUSB0}
      - BLE_ADDRESS=${BLE_ADDRESS:-}
      
      # Logging
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      
      # Timeout configurations (in seconds)
      - TCP_TIMEOUT=${TCP_TIMEOUT:-300}           # TCP connection timeout (default: 5 minutes)
      - CONFIG_WAIT_TIMEOUT=${CONFIG_WAIT_TIMEOUT:-60}  # Wait for node config (default: 1 minute)
      - POLL_INTERVAL=${POLL_INTERVAL:-1}         # Config polling interval (default: 1 second)
    volumes:
      - ./tcp-mqtt-proxy.py:/app/tcp-mqtt-proxy.py
      - /var/run/dbus:/var/run/dbus  # Required for BLE access
      - /var/lib/bluetooth:/var/lib/bluetooth:ro  # Required for BLE pairing data
    devices:
      # Serial devices for Meshtastic nodes
      - /dev/ttyACM0:/dev/ttyACM0
      - /dev/ttyACM1:/dev/ttyACM1
      # - /dev/ttyUSB0:/dev/ttyUSB0
    cap_add:
      - NET_ADMIN  # Required for BLE
      - SYS_ADMIN  # Required for BLE
    privileged: true  # Required for serial device access
    network_mode: host
